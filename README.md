<h1 align="center" style="font-size: 50px">
    Snapshot ETL
</h1>

## Local Development

#### Install cargo make to run pre-configured commands in `Makefile.toml`.

```shell
cargo install cargo-make
```

#### Start Backfill

Epoch reads the `backfill.yaml` config file which defines the snapshots to pull from Google Cloud Storage (GCS), the
GCS bucket to pull from, the number of workers/threads to parallelize tasks, and the Solana programs to filter for.
Example:

```yaml
# Maximum number of cores to use for processing.
max_workers: 4

# Only these programs will be uploaded to Timescale.
programs:
  - dRiftyHA39MWEi3m9aunc5MzRF1JYuBsbn6VPcn33UH # drift v2
  - jupoNjAxXgZ4rjzxzPMP4oxduvQsQtZzyknqvzYNrNu # Jupiter limit
  - PERPHjGBqRHArX4DySjwM6UJHiR3sWAatqfdBS2qQJu # Jupiter perp
  - JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4 # Jupiter swap
  - PhoeNiXZ8ByJGLkxNfZRnkUfjvmuYqLR89jjFHGqdXY # Phoenix

# Oldest slot to backfill
start_slot: 240000000
# Newest slot to backfill
end_slot: 280000000

gcs_bucket: mainnet-beta-ledger-us-ny5
# Optional local file with GCS snapshot object data. If not provided, the snapshot will be downloaded from GCS
gcs_local_file: gcs_snapshots.json
```

Run this command to start uploading decoded accounts from BigTable to Timescale

```shell
cargo make backfill
```

### Supporting New Programs

Create a new library crate in `idls` as `idls/<program-name>`.

The `idls` directory contains bindings auto-generated by `anchor-gen` using an IDL.
Fetch the IDL via the Anchor CLI:

```shell
anchor idl fetch -o <where-to-store.json> <program-id> --provider.cluster mainnet
```

The JSON location should be the root of the new program crate in `idls`, such as `idls/<program-name>/idl.json`.

You only need one file, `idls/<program-name>/src/lib.rs`, and two lines of code to auto-generate bindings based on
the IDL.
You can use `idls/drift/src/lib.rs` as a reference implementation.

```rust
anchor_gen::generate_cpi_crate!("idl.json");
anchor_lang::declare_id!("<paste-your-program-id-here>");
```

See [anchor-gen](https://github.com/staratlasmeta/anchor-gen) for easy usage of referencing, reading, and decoding
any account or instruction for your program.

### Further Reading

Schema of a snapshot by Richard Patel [here](https://gist.github.com/ripatel-fd/268c88d938075537ec6431e2960f47dd)







